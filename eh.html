<!DOCTYPE html>
<html>
<head>
<style>
textarea {
}
</style>
</head>
<body>

<h1>Drawing Transpiler</h1>

<h2>Run 'make', then paste the generated JSON file below (e.g. test5.json)</h2>

<button onclick="generate ()">Generate Python from JSON drawing spec</button>

<br>
<p id="status" > READY </p>
<br>

<p>JSON:</p>
<textarea id="drawio" rows="7" cols="120" placeholder="drawio file" style="background-color:oldlace;">
</textarea>

<p>intermediate:</p>
<textarea id="intermediate" rows="7" cols="120" placeholder="drawio file" style="background-color:oldlace;">
</textarea>


<p>Python code:</p>
<textarea id="output" rows="17" cols="120" placeholder="transpiled"  readonly style="background-color:whitesmoke;">
</textarea>
<br>
<br>
<br>

<!-- Ohm-JS -->
<script src="https://unpkg.com/ohm-js@16/dist/ohm.min.js"></script>


<!-- Macro preprocessor -->
    <script src="fmt-js/fmt-js.js"></script>
    <script src="fmt-js/transpile.js"></script>

<!-- phases -->
    <script src="das1.js"></script>
    <script src="das2.js"></script>

<script>

  function stripQuotes (s) {
      return s.replace (/"/g,'');
  }
  

const jsonsrc = String.raw`
[
  [
    {
      "children": [ {"kind":"Hello", "name":"cell_7"},  {"kind":"World", "name":"cell_8"} ],
      "connections": [
	{
	  "receivers": [ {"receiver": {"component":"cell_7", "port":"b"}} ],
	  "senders": [ {"sender": {"component":"cell_6", "port":"a"}} ]
	},
	{
	  "receivers": [ {"receiver": {"component":"cell_8", "port":"d"}} ],
	  "senders": [ {"sender": {"component":"cell_7", "port":"c"}} ]
	},
	{
	  "receivers": [ {"receiver": {"component":"cell_6", "port":"f"}} ],
	  "senders": [ {"sender": {"component":"cell_8", "port":"e"}} ]
	}
      ],
      "id":"cell_6",
      "inputs": ["cell_17" ],
      "kind":"HelloWorld",
      "name":"HelloWorld",
      "outputs": ["cell_15" ],
      "synccode":""
    }
  ],
  [
    {
      "children": [],
      "connections": [],
      "id":"cell_7",
      "inputs": ["cell_12" ],
      "kind":"Hello",
      "name":"Hello",
      "outputs": ["cell_10" ],
      "synccode":""
    }
  ],
  [
    {
      "children": [],
      "connections": [],
      "id":"cell_8",
      "inputs": ["cell_11" ],
      "kind":"World",
      "name":"World",
      "outputs": ["cell_14" ],
      "synccode":""
    }
  ]
]
`;


  var selfid2stack = [];
  
  function stacktop (stack) {
      var len = stack.length;
      return stack [len - 1];
  }

  function stackpop (stack) {
      stack.pop ();
  }
  
  function stackreset (stack) {
      stack = [];
  }

  function settop (stack, val) {
      var len = stack.length;
      stack [len - 1] = val;
  }

  function panic (s) {
      var message = `internal error ${s}`;
      throw message;
  }

  
// selfid2 mechanism ...
  function setSelfid2 (s) {
      console.log (`setSelfid2 ${s}`);
      settop (selfid2stack, s);
      return '';
  }

  function maybeMapSelf (s) {
      var selfid2 = stacktop (selfid2stack);
      console.log (`maybeMapSelf ${s} ${selfid2}`);
      if (s === selfid2) {
	  return 'self';
      } else {
	  return s;
      }
  }

  function selfid2reset () {
      stackreset (selfid2stack);
  }

// ... selfid2 mechanism
  



  function test (field, src, grammarName, grammar, fmt) {
      document.getElementById(field).innerHTML = src;
      [success, transpiled, errormessage] = transpile (src, grammarName, grammar, fmt);
      if (success) {
          document.getElementById('output').value = transpiled;
          document.getElementById('status').innerHTML = "OK";
	  return [true, transpiled];
      } else {
          document.getElementById('output').value = transpiled;
          document.getElementById('status').innerHTML = "FAILED " + errormessage;
	  return [false, transpiled];
      }
  }
  
  function generate () {
      [r, phase1result] = test ('drawio', jsonsrc, "DaS", dasgrammar, dasfmt);
      console.log (`phase 1 ${r}`);
      [r2, phase2result] = test ('intermediate', phase1result, "DaSphase2", dasgrammar2, dasfmt2);
      console.log (`self resolution (phase 2) ${r2}`);
  }

  </script>
</body>
</html>


