<!DOCTYPE html>
<html>
<head>
<style>
textarea {
}
</style>
</head>
<body>

<h1>Drawing Transpiler</h1>

<h2>Run 'make', then paste the generated JSON file (e.g. test5.json) into src.js</h2>

<button onclick="generate ()">Generate</button>

<br>
<p id="status" > READY </p>
<br>

<p>JSON:</p>
<textarea id="drawio" rows="7" cols="120" placeholder="drawio file" style="background-color:oldlace;">
</textarea>


<p>output:</p>
<textarea id="output" rows="20" cols="120" placeholder="transpiled output" style="background-color:oldlace;">
</textarea>

<p>input:</p>
<textarea id="input" rows="20" cols="120" placeholder="input to last item in pipeline" style="background-color:oldlace;">
</textarea>


<br>
<br>
<br>

<!-- Ohm-JS -->
<script src="https://unpkg.com/ohm-js@16/dist/ohm.min.js"></script>


<!-- Macro preprocessor -->
    <script src="fmt-js/fmt-js.js"></script>
    <script src="fmt-js/transpile.js"></script>

<!-- utilities -->
    <script src="stack.js"></script>
    <script src="panic.js"></script>
    <script src="quotes.js"></script>
    <script src="chars.js"></script>

<!-- mechanisms -->
    <script src="selfid2.js"></script>
    <script src="selfkind.js"></script>
    
<!-- end user grammar -->
    <script src="dasgrammar.js"></script>

<!-- reusable fmts -->
    <script src="fstring.js"></script>
    <script src="fmisc.js"></script>
    <script src="finsert.js"></script>

<!-- phases -->
    <script src="seminsertselfdecl.js"></script>
    <script src="semreplacewithself.js"></script>
    <script src="identityemitter.js"></script>
    <script src="childimports.js"></script>
    <script src="classbegin.js"></script>

<!-- source code -->
    <script src="src.js"></script>

<script>

  function removeVerbatimBrackets (s) {
      return s.replace (/‹/g,'').replace (/›/g,'');
  }
  
  function test (src, grammarName, grammar, fmt) {
      document.getElementById('input').innerHTML = src;      
      [success, transpiled, errormessage] = transpile (src, grammarName, grammar, fmt);
      if (success) {
	  document.getElementById('output').value = transpiled;
          document.getElementById('status').innerHTML = "OK";
	  return [true, transpiled];
      } else {
          document.getElementById('output').value = '<error>';
          document.getElementById('status').innerHTML = "FAILED " + grammarName + ' ' + errormessage;
	  return [false, errormessage];
      }
  }

  function generate () {
      src = jsonsrc;
      document.getElementById('drawio').innerHTML = src;

// Information Gatherer ("semantics" passes)

      let r = undefined;
      let output = '';
      [r, output] = test (src, "DaS", dasgrammar, dasfmt);
      r && ([r, output] = test (output, "DaSphase2", dasgrammar2, dasfmt2));
      
// Code Emitter

      var transformedCode = output;
      
      const boilerPlateImports = `
${lv}
from message import Message
from container import Container
from connect import Connect
from sender import Sender
from receiver import Receiver
${rv}
`;
      let childImports = '';
      let classBegin = '';
//      r && ([r, childImports] = test (transformedCode, "ChildImports", gChildImports, fChildImports));
//      r && ([r, classBegin] = test (transformedCode, "ClassBegin", gClassBegin, fClassBegin));
//x      r && (r = test ("Emitter", gEmitter, fEmitter));

      let finalCode = boilerPlateImports + childImports + classBegin;
      finalCode = removeVerbatimBrackets (finalCode);
      console.log (finalCode);
      
  }

  </script>
</body>
</html>


