<!DOCTYPE html>
<html>
<head>
<style>
textarea {
}
</style>
</head>
<body>

<h1>Drawing Transpiler</h1>

<h2>Run 'make', then paste the generated JSON file below (e.g. test5.json)</h2>

<button onclick="generate ()">Generate Python from JSON drawing spec</button>

<br>
<p id="status" > READY </p>
<br>

<p>JSON:</p>
<textarea id="drawio" rows="17" cols="120" placeholder="drawio file" style="background-color:oldlace;">
</textarea>


<p>Python code:</p>
<textarea id="output" rows="17" cols="120" placeholder="transpiled"  readonly style="background-color:whitesmoke;">
</textarea>
<br>
<br>
<br>

<!-- Ohm-JS -->
<script src="https://unpkg.com/ohm-js@16/dist/ohm.min.js"></script>


<!-- Macro preprocessor -->
    <script src="fmt-js.js"></script>
    <script src="transpile.js"></script>

<script>


const jsonsrc = String.raw`
[
  [
    {
      "children": [ {"kind":"hello", "name":"cell_7"},  {"kind":"world", "name":"cell_8"} ],
      "connections": [
	{
	  "receivers": [ {"receiver": {"component":"cell_7", "port":""}} ],
	  "senders": [ {"sender": {"component":"cell_6", "port":""}} ]
	},
	{
	  "receivers": [ {"receiver": {"component":"cell_8", "port":""}} ],
	  "senders": [ {"sender": {"component":"cell_7", "port":""}} ]
	},
	{
	  "receivers": [ {"receiver": {"component":"cell_6", "port":""}} ],
	  "senders": [ {"sender": {"component":"cell_8", "port":""}} ]
	}
      ],
      "id":"cell_6",
      "inputs": ["cell_17" ],
      "kind":"helloworld",
      "name":"helloworld",
      "outputs": ["cell_15" ],
      "synccode":""
    }
  ],
  [
    {
      "children": [],
      "connections": [],
      "id":"cell_7",
      "inputs": ["cell_12" ],
      "kind":"hello",
      "name":"hello",
      "outputs": ["cell_10" ],
      "synccode":""
    }
  ],
  [
    {
      "children": [],
      "connections": [],
      "id":"cell_8",
      "inputs": ["cell_11" ],
      "kind":"world",
      "name":"world",
      "outputs": ["cell_14" ],
      "synccode":""
    }
  ]
]
`;

  const dasgrammar = String.raw`
DaS {
Components = "[" (Component ","?) + "]"
Component = "[" ComponentJSON "]"
ComponentJSON = ComponentContainerJSON | ComponentLeafJSON
ComponentContainerJSON = "{" NonEmptyChildren ComponentField+ "}"
ComponentLeafJSON = "{" EmptyChildren ComponentField+ "}"

EmptyChildren = dq "children" dq ":" "[" "]" ","?
NonEmptyChildren = dq "children" dq ":" ChildList ","?

ComponentField = CField ","?

CField =
  | dq "id" dq ":" string                   -- id
  | dq "inputs" dq ":" StringList           -- inputs
  | dq "name" dq ":" string                 -- name
  | dq "kind" dq ":" string                 -- kind
  | dq "outputs" dq ":" StringList          -- outputs
  | dq "synccode" dq ":" string             -- synccode
  | dq "connections" dq ":" ConnectionBody  -- connections

ConnectionBody = "[" Connection* "]"

Connection = "{" Receiver "," Sender "}" ","?
Receiver = dq "receivers" dq ":" "[" "{" dq "receiver" dq ":" Pair "}" "]"
Sender = dq "senders" dq ":" "[" "{" dq "sender" dq ":" Pair "}" "]"

Pair = "{" kwcomponent ":" ComponentName "," kwport ":" PortName "}"
kwcomponent = dq "component" dq
kwport = dq "port" dq
ComponentName = string
PortName = string

ChildList = "[" Child* "]"
Child = "{" kkind ":" KindName "," kname ":" ComponentName "}" ","?
kkind = dq "kind" dq
KindName = string
kname = dq "name" dq


StringList = "[" (string ","?)* "]"
string = dq (~dq any)* dq
dq = "\""
}
`;


  function test (src, grammarName, grammar, fmt) {
      document.getElementById('drawio').innerHTML = src;
      [success, transpiled, errormessage] = transpile (src, grammarName, grammar, fmt);
      if (success) {
	  document.getElementById('output').value = transpiled;
	  document.getElementById('status').innerHTML = "OK";
      } else {
	  document.getElementById('output').value = transpiled;
	  document.getElementById('status').innerHTML = "FAILED " + errormessage;
      }
  }
  
  function generate () {
      test (jsonsrc, "DaS", dasgrammar, undefined /*fmt*/);
  }
  
  </script>
</body>
</html>


